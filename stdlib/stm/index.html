<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.1.2, mkdocs-material-5.4.0"><title>STM</title><link rel=stylesheet href=../../assets/stylesheets/main.fe0cca5b.min.css><link href=https://fonts.gstatic.com rel=preconnect crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback"><style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style><script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-1855461-3","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})}),document.addEventListener("DOMContentSwitch",function(){ga("send","pageview")})</script><script async src=https://www.google-analytics.com/analytics.js></script></head> <body dir=ltr> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#usage class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header-nav md-grid" aria-label=Header> <a href=../.. title="Yatta Language" class="md-header-nav__button md-logo" aria-label="Yatta Language"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg> </a> <label class="md-header-nav__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg> </label> <div class=md-header-nav__title data-md-component=header-title> <div class=md-header-nav__ellipsis> <span class="md-header-nav__topic md-ellipsis"> Yatta Language </span> <span class="md-header-nav__topic md-ellipsis"> STM </span> </div> </div> <label class="md-header-nav__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query data-md-state=active> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </label> <button type=reset class="md-search__icon md-icon" aria-label=Clear data-md-component=search-reset tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg> </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header-nav__source> <a href=https://github.com/yatta-lang/yatta/ title="Go to repository" class=md-source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg> </div> <div class=md-source__repository> yatta-lang/yatta </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="Yatta Language" class="md-nav__button md-logo" aria-label="Yatta Language"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg> </a> Yatta Language </label> <div class=md-nav__source> <a href=https://github.com/yatta-lang/yatta/ title="Go to repository" class=md-source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg> </div> <div class=md-source__repository> yatta-lang/yatta </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. title=Home class=md-nav__link> Home </a> </li> <li class=md-nav__item> <a href=../../usecase/ title=Usecase class=md-nav__link> Usecase </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3 type=checkbox id=nav-3> <label class=md-nav__link for=nav-3> Getting Started <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label="Getting Started" data-md-level=1> <label class=md-nav__title for=nav-3> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> Getting Started </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../installation/ title=Installation class=md-nav__link> Installation </a> </li> <li class=md-nav__item> <a href=../../release-notes/ title="Release Notes" class=md-nav__link> Release Notes </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../syntax/ title=Syntax class=md-nav__link> Syntax </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-5 type=checkbox id=nav-5> <label class=md-nav__link for=nav-5> Features <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=Features data-md-level=1> <label class=md-nav__title for=nav-5> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> Features </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../operators/ title=Operators class=md-nav__link> Operators </a> </li> <li class=md-nav__item> <a href=../../data-types/ title="Data Types" class=md-nav__link> Data Types </a> </li> <li class=md-nav__item> <a href=../../pattern-matching/ title="Pattern Matching" class=md-nav__link> Pattern Matching </a> </li> <li class=md-nav__item> <a href=../../module-loader/ title="Module Loader" class=md-nav__link> Module Loader </a> </li> <li class=md-nav__item> <a href=../../polyglot/ title="Polyglot APIs" class=md-nav__link> Polyglot APIs </a> </li> <li class=md-nav__item> <a href=../../resource-management/ title="Resource Management" class=md-nav__link> Resource Management </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../ title="Standard Library" class=md-nav__link> Standard Library </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> Table of contents </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#usage class=md-nav__link> Usage </a> <nav class=md-nav aria-label=Usage> <ul class=md-nav__list> <li class=md-nav__item> <a href=#instantiating-a-new-stm class=md-nav__link> Instantiating a new STM </a> </li> <li class=md-nav__item> <a href=#creating-a-var-key-for-some-value-in-the-stm class=md-nav__link> Creating a var - key for some value in the STM </a> </li> <li class=md-nav__item> <a href=#starting-a-read-only-transaction class=md-nav__link> Starting a read-only transaction </a> </li> <li class=md-nav__item> <a href=#starting-a-read-write-transaction class=md-nav__link> Starting a read-write transaction </a> </li> <li class=md-nav__item> <a href=#updating-the-stm class=md-nav__link> Updating the STM </a> </li> <li class=md-nav__item> <a href=#reading-a-value-of-a-var class=md-nav__link> Reading a value of a var </a> </li> <li class=md-nav__item> <a href=#writing-to-a-var class=md-nav__link> Writing to a var </a> </li> <li class=md-nav__item> <a href=#protecting-a-var-from-a-concurrent-write-in-another-transaction class=md-nav__link> Protecting a var from a concurrent write in another transaction </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#complete-example class=md-nav__link> Complete example </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content> <article class="md-content__inner md-typeset"> <a href=https://github.com/yatta-lang/yatta/edit/master/docs/stdlib/stm.md title="Edit this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg> </a> <h1>STM</h1> <p>Module <code>STM</code> provides access to a built-in Software Transactional Memory data structure, which can be thought of as a mutable map, safe from concurrent access.</p> <h2 id=usage>Usage<a class=headerlink href=#usage title="Permanent link">&para;</a></h2> <p>There may be multiple instances of STM created in Yatta, and they live completely independently to each other. Any error raised by functions in this module raise an exception of type <code>:stm</code>.</p> <h3 id=instantiating-a-new-stm>Instantiating a new STM<a class=headerlink href=#instantiating-a-new-stm title="Permanent link">&para;</a></h3> <p>In order to use an STM for read/write operations, one must first create the STM itself. Reference to the STM instance will be used by all other functions. STM itself is of a special <a href=/docs/data-types.md>type</a> <code>stm</code>.</p> <p>Example: <div class=highlight><pre><span></span><code><span class=nf>stm</span> <span class=ow>=</span> <span class=kt>STM</span><span class=ow>::</span><span class=n>new</span>
</code></pre></div></p> <h3 id=creating-a-var-key-for-some-value-in-the-stm>Creating a var - key for some value in the STM<a class=headerlink href=#creating-a-var-key-for-some-value-in-the-stm title="Permanent link">&para;</a></h3> <p>STM uses concepts of vars, which are references to the STM, and they are actually their own special type in Yatta.</p> <p>Creating a new var: <div class=highlight><pre><span></span><code><span class=nf>var</span> <span class=ow>=</span> <span class=kt>STM</span><span class=ow>::</span><span class=n>var</span> <span class=n>stm</span> <span class=n>initial_value</span>
</code></pre></div></p> <p>Creating a new var requires the STM instance and an initial value this var holds.</p> <h3 id=starting-a-read-only-transaction>Starting a read-only transaction<a class=headerlink href=#starting-a-read-only-transaction title="Permanent link">&para;</a></h3> <p>Function <code>read_tx</code> creates a read-only transaction wrapped in a <a href=/docs/resource-management.md#context-managers>context manager</a>. It takes a reference to the STM system and returns the context manager.</p> <p>Access the STM in a transaction: <div class=highlight><pre><span></span><code><span class=nf>with</span> <span class=kt>STM</span><span class=ow>::</span><span class=n>read_tx</span> <span class=n>stm</span>
    <span class=kt>STM</span><span class=ow>::</span><span class=n>run</span> <span class=p>(</span><span class=o>\-&gt;</span> <span class=n>check_balance</span><span class=p>)</span>
<span class=nf>end</span>
</code></pre></div></p> <h3 id=starting-a-read-write-transaction>Starting a read-write transaction<a class=headerlink href=#starting-a-read-write-transaction title="Permanent link">&para;</a></h3> <p>Function <code>write_tx</code> creates a read-write transaction wrapped in a <a href=/docs/resource-management.md#context-managers>context manager</a>. It takes a reference to the STM system and returns the context manager.</p> <p>Access the STM in a transaction: <div class=highlight><pre><span></span><code><span class=nf>with</span> <span class=kt>STM</span><span class=ow>::</span><span class=n>write_tx</span> <span class=n>stm</span>
    <span class=kt>STM</span><span class=ow>::</span><span class=n>run</span> <span class=p>(</span><span class=o>\-&gt;</span> <span class=n>withdraw</span><span class=p>)</span>
<span class=nf>end</span>
</code></pre></div></p> <h3 id=updating-the-stm>Updating the STM<a class=headerlink href=#updating-the-stm title="Permanent link">&para;</a></h3> <p>Updating a value held by a var must take place inside a transaction. Function <code>run</code> takes a 0-argument lambda, which is the actual code executed inside a transaction. The return value of the <code>run</code> function is the return value of the provided lambda.</p> <p>Example: <div class=highlight><pre><span></span><code><span class=kt>STM</span><span class=ow>::</span><span class=n>run</span> <span class=n>stm</span> <span class=p>(</span><span class=o>\-&gt;</span> <span class=n>withdraw</span><span class=p>)</span>
</code></pre></div></p> <p>Note that passing a zero argument lambda <a href=/docs/syntax.md#anonymous-functions-aka-lambdas>requires</a> it to be wrapped in another lambda, this is to prevent its eager evaluation.</p> <h3 id=reading-a-value-of-a-var>Reading a value of a var<a class=headerlink href=#reading-a-value-of-a-var title="Permanent link">&para;</a></h3> <p>A var may be read either inside or outside of a transaction. Reading a var outside of a transaction, aka a dirty read, may provide a value that has been modified by another running transaction and not yet committed. Funciton <code>read</code> expects one argument, the var and returns a value this var contains.</p> <p>Example: <div class=highlight><pre><span></span><code><span class=nf>value</span> <span class=ow>=</span> <span class=kt>STM</span><span class=ow>::</span><span class=n>read</span> <span class=n>var</span>
</code></pre></div></p> <h3 id=writing-to-a-var>Writing to a var<a class=headerlink href=#writing-to-a-var title="Permanent link">&para;</a></h3> <p>Function <code>var</code> must be called within a transaction. It expects var and the new value to be written. This function returns a <code>()</code>.</p> <p>Example: <div class=highlight><pre><span></span><code><span class=kt>STM</span><span class=ow>::</span><span class=n>write</span> <span class=n>var</span> <span class=n>new_value</span>
</code></pre></div></p> <h3 id=protecting-a-var-from-a-concurrent-write-in-another-transaction>Protecting a var from a concurrent write in another transaction<a class=headerlink href=#protecting-a-var-from-a-concurrent-write-in-another-transaction title="Permanent link">&para;</a></h3> <p>Function <code>protect</code> ensures that a var cannot be overriden from another transaction. If such change did occur, the current transaction would fail. This function expects a var and returns a <code>()</code>.</p> <p>Example: <div class=highlight><pre><span></span><code><span class=kt>STM</span><span class=ow>::</span><span class=n>protect</span> <span class=n>var</span>
</code></pre></div></p> <h2 id=complete-example>Complete example<a class=headerlink href=#complete-example title="Permanent link">&para;</a></h2> <p>The following example shows a simple program for withdrawing money from an account. 10 currency is withdrawn 100 times concurrently:</p> <div class=highlight><pre><span></span><code><span class=kr>let</span>
    <span class=n>stm</span> <span class=ow>=</span> <span class=kt>STM</span><span class=ow>::</span><span class=n>new</span>
    <span class=n>balance</span> <span class=ow>=</span> <span class=kt>STM</span><span class=ow>::</span><span class=n>var</span> <span class=n>stm</span> <span class=mi>1000</span><span class=n>f</span>

    <span class=n>withdraw</span> <span class=ow>=</span> <span class=n>async</span> <span class=o>\-&gt;</span> <span class=kr>let</span> <span class=n>old_balance</span> <span class=ow>=</span> <span class=p>(</span><span class=kt>STM</span><span class=ow>::</span><span class=n>read</span> <span class=n>balance</span><span class=p>)</span> <span class=kr>in</span> <span class=kt>STM</span><span class=ow>::</span><span class=n>write</span> <span class=n>balance</span> <span class=p>(</span><span class=n>old_balance</span> <span class=o>-</span> <span class=mi>10</span><span class=n>f</span><span class=p>)</span>

    <span class=n>max_iterations</span> <span class=ow>=</span> <span class=mi>100</span>

    <span class=n>run</span> <span class=ow>=</span> <span class=nf>\</span><span class=n>i</span> <span class=ow>-&gt;</span> <span class=kr>case</span> <span class=n>i</span> <span class=kr>of</span>
      <span class=n>x</span> <span class=o>|</span> <span class=n>x</span> <span class=o>&gt;=</span> <span class=n>max_iterations</span> <span class=ow>-&gt;</span> <span class=kt>STM</span><span class=ow>::</span><span class=n>read</span> <span class=n>balance</span>
      <span class=n>x</span> <span class=ow>-&gt;</span> <span class=kr>do</span>
          <span class=kt>STM</span><span class=ow>::</span><span class=n>transaction</span> <span class=n>stm</span> <span class=n>false</span> <span class=p>(</span><span class=o>\-&gt;</span> <span class=n>withdraw</span><span class=p>)</span>
          <span class=n>run</span> <span class=p>(</span><span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>
          <span class=n>end</span>
        <span class=n>end</span>
<span class=kr>in</span>
    <span class=n>run</span> <span class=mi>0</span>
</code></pre></div> <hr> <div class=md-source-date> <small> Last update: July 1, 2020 </small> </div> </article> </div> </div> </main> </div> <script src=../../assets/javascripts/vendor.d710d30a.min.js></script> <script src=../../assets/javascripts/bundle.b39636ac.min.js></script><script id=__lang type=application/json>{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script> <script>
        app = initialize({
          base: "../..",
          features: [],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.a68abb33.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script> </body> </html>